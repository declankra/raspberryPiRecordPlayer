# NFC Spotify Player - Stability Fixes (2025-12-30)

## Problem
The Raspberry Pi NFC record player would stop working after a few hours of operation. The goal was to make it run indefinitely so users can place NFC-tagged pictures at any time to play songs.

## Root Causes Identified

### 1. File Descriptor Leak (Critical)
**Location:** `idToMp3.py:44`

**Issue:** JSON file opened without context manager, called every second (~3,600 times/hour). Eventually exhausted OS file descriptor limit causing crashes.

```python
# Before (leaked file handles)
vinyl_collection = json.load(open('/home/pi/raspberryPiRecordPlayer/vinylCollection.json'))

# After (properly closed)
with open('/home/pi/raspberryPiRecordPlayer/vinylCollection.json') as f:
    vinyl_collection = json.load(f)
```

### 2. Zombie Process Accumulation (Critical)
**Location:** `idToMp3.py:7-31`

**Issue:** Node.js subprocess spawned every second for NFC reading. When timeout occurred, process wasn't killed, leaving zombie processes that accumulated until system became unresponsive.

```python
# Added explicit cleanup
except subprocess.TimeoutExpired:
    if process:
        process.kill()
        process.wait()  # Reap the zombie process
    return None
finally:
    # Ensure process is cleaned up in all cases
    if process and process.poll() is None:
        process.kill()
        process.wait()
```

### 3. Environment Variables Not Loading
**Location:** `player.py:1-10`

**Issue:** `player.py` used `os.getenv()` but never called `load_dotenv()`, so `.env` file wasn't being read. Device ID and credentials weren't loaded properly.

```python
# Added at top of player.py
from dotenv import load_dotenv
load_dotenv('/home/pi/raspberryPiRecordPlayer/.env')
```

### 4. Dangerous exit() Call
**Location:** `player.py:74`

**Issue:** On certain API errors, code called `exit()` which terminated the entire service with no recovery.

```python
# Before (crashed on errors)
else:
    print("Failed to get current playback state:", response.text)
    return exit()

# After (graceful handling)
else:
    print(f"Failed to get current playback state ({response.status_code}):", response.text)
    return None
```

### 5. No Process Management
**Issue:** Service ran via `@reboot` crontab with no auto-restart capability. Any crash was permanent until manual intervention.

**Solution:** Created systemd service with `Restart=always`.

## Files Modified

| File | Changes |
|------|---------|
| `idToMp3.py` | Fixed file descriptor leak, added subprocess cleanup |
| `player.py` | Added `load_dotenv()`, removed `exit()`, added exception handling, changed volume to 35% |

## Files Created

| File | Purpose |
|------|---------|
| `nfc-spotify.service` | systemd service for auto-restart and process management |
| `deploy.sh` | One-command deployment script |
| `FIXES_2025-12-30.md` | This document |

## systemd Service

The new systemd service (`/etc/systemd/system/nfc-spotify.service`) provides:
- Auto-restart on failure (10 second delay)
- Proper environment loading from `.env`
- Memory limits (256M max)
- Log output to `/home/pi/raspberryPiRecordPlayer/logs/`

### Useful Commands
```bash
# Check status
sudo systemctl status nfc-spotify

# View logs
tail -f /home/pi/raspberryPiRecordPlayer/logs/player.log

# Restart service
sudo systemctl restart nfc-spotify

# Check for zombie processes
ps aux | grep readNfcTag | wc -l
```

## Configuration Changes

### Spotify Device ID
Updated `.env` to use "Everywhere" speaker group:
```
SPTOTIFY_CONNECTED_DEVICE_ID_REAL=6026c126-8d57-4ed5-a173-a9240c99b43b_amzn_3
SPTOTIFY_CONNECTED_DEVICE_ID_TRIMMED=6026c126-8d57-4ed5-a173-a9240c99b43b
```

### Volume
Changed default volume from 50% to 35% in `player.py:135`.

## Deployment

To deploy future changes:
```bash
./deploy.sh
```

Or manually:
```bash
# Sync files
rsync -avz --exclude 'node_modules' --exclude '.git' ./ pi@10.0.0.114:/home/pi/raspberryPiRecordPlayer/

# Restart service
ssh pi@10.0.0.114 'sudo systemctl restart nfc-spotify'
```

## Verification

After deployment, verify fixes are working:
```bash
# Check only 1-2 node processes (not accumulating)
ssh pi@10.0.0.114 'ps aux | grep readNfcTag | grep -v grep | wc -l'

# Check service is active
ssh pi@10.0.0.114 'sudo systemctl is-active nfc-spotify'

# Check memory is stable
ssh pi@10.0.0.114 'free -h'
```
